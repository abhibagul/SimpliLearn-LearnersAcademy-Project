<%@ page language="java" contentType="text/html; charset=ISO-8859-1"
    pageEncoding="ISO-8859-1"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Manage Session</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

<link href="dashboard.css" rel="stylesheet">
</head>
<body  class="bg-light">
	<%@page import="java.sql.DriverManager"%>
	<%@page import="java.sql.ResultSet"%>
	<%@page import="java.sql.Statement"%>
	<%@page import="java.sql.Connection"%>
	<%@page import="java.sql.PreparedStatement" %>
	<%
		String session_u_name = (String)session.getAttribute("usname");
		String role = (String)session.getAttribute("role");	
	
		if(role != "admin"){
			response.sendRedirect("admin.jsp");
			
		}
		
		String driverName = "com.mysql.jdbc.Driver";
		String connectionUrl = "jdbc:mysql://localhost:3306/";
		String dbName = "learnersacademy";
		String userId = "root";
		String password = "root12345";
		
		
		String action = (String) request.getParameter("action");
		
		try {
			Class.forName(driverName);
		} catch (ClassNotFoundException e) {
			e.printStackTrace();
		}
	
		Connection connection = null;
		Statement statement = null;
		ResultSet resultSet = null;
		ResultSet teacherRes = null;
		ResultSet subRes = null;
	
		try{
			
			connection = DriverManager.getConnection(connectionUrl+dbName, userId, password);
			statement=connection.createStatement();
		
			//deleting division
			if(action.equals("deleteSesison") && request.getParameter("sesId") != null){
				PreparedStatement delPS = connection.prepareStatement("DELETE FROM session where id=?");
				delPS.setString(1, request.getParameter("sesId"));
				delPS.execute();
			}
		}catch(Exception e){
			e.printStackTrace();
		}
		
	
		
		if(request.getParameter("sesId") != null){
			String sesId = request.getParameter("sesId");
		}
		else{
			response.sendRedirect("manageSession.jsp");
		}
	
%>

<main>
	<jsp:include page="sidebarComp.jsp"/>

	<div class="data">
	
	<jsp:include page="headerComp.jsp"/>
  
	
	<div class="p-3 control">


	
	
	<div class="row">
			<div class="col-sm-6">
				<h4><i class="bi bi-person-video2"></i> Manage Sessions</h4>
			</div>
		</div>
  
  
  	<div class="my-3 p-3 bg-body rounded shadow-sm">
  	
		<div class="row">
  <div class="col-lg-6 col-md-6 ">
  <form id="sesDateSel" action="<%=request.getContextPath()%>/manageSession.jsp" method="post"  class="row ">
  	<div class="">
    <input type="hidden" name="action" value="dateSelector">
    </div>
    <div class="col-sm-6">
		<input type="date" name="sesDate" onchange="document.getElementById('sesDateSel').submit();">
	</div>
  </form>
  </div>
  
	</div>
	
	
	</div>
	
	
	<div class="my-3">
		<%
		
			//out.print("Content: " + action + " for std, " + request.getParameter("selectedStd"));
			if(action != null ){
				
				
				if( action.equals("dateSelector") || action.equals("deleteStudent")){
					
					PreparedStatement ps = connection.prepareStatement("SELECT * FROM session where id=?");
					ps.setString(1, request.getParameter("sesId"));
					
					%>
					<div class="row">
					<div class="col-lg-6 col-sm-6">
					
					<h4>Sessions on <%= request.getParameter("sesDate") %></h4>
					</div>
					</div>
					<hr/>
					<%
					
						
					try{
											
						
						resultSet = ps.executeQuery();
						
						
							%>
						
						<div class="row">
						
								<% while(resultSet.next()){ %>
							
								<div class="col-lg-4 col-md-6 col-sm-12 px-3 py-1">

				<div class=" p-3 bg-body rounded shadow-sm">
					<h5><%= resultSet.getString("sessionName") %></h5>
					<span class="badge bg-secondary">Starts at <%= resultSet.getString("sessionStartTime")
					
					
					%></span>
					<hr/>
					<p>Teacher: <%
					PreparedStatement psTeacher = connection.prepareStatement("SELECT * FROM teacher where id=?");
					psTeacher.setString(1, resultSet.getString("teacher"));
					teacherRes = psTeacher.executeQuery();
					
						while(teacherRes.next()){
							out.print(teacherRes.getString("name"));
						}
					
					%></p>
					<p>Subject: <%
					PreparedStatement pssub = connection.prepareStatement("SELECT * FROM subject where id=?");
					pssub.setString(1, resultSet.getString("subject"));
					subRes = pssub.executeQuery();
					
						while(subRes.next()){
							out.print(subRes.getString("name"));
						}
					
					%></p>
					<form method="post" action="viewSessionInfo.jsp">
						<input type="hidden" name="id" value="<%= resultSet.getString("id") %>">
						<input class="btn btn-primary" type="submit" value="More Info">
					</form>
				</div>
				</div>
								
								<% } %>
								
						</div>
			<%
						
					}catch(Exception e){
						e.printStackTrace();
					}
					
			
				}
				
				
			}else{
				%>
				
				<h4 class="text-center">Please select date for which you want to view the sessions.</h4>
				
				<%
			}
		%>
	</div>
	
	</div>
	<!-- /main content -->
	</div>
	
	</main>

</body>
</html>